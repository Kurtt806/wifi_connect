<!DOCTYPE html>
<html>
<head>
    <title>VIBO Config</title>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="referrer no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <style type="text/css">
        /* ========== Modern UI Design ========== */
        :root {
            /* Light Theme (Default) - Moss Green Primary */
            --primary-color: #22c55e; /* Moss green */
            --primary-hover: #16a34a;
            --primary-light: #4ade80;
            --secondary-color: #64748b;
            --accent-color: #059669; /* Emerald */
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --background-primary: linear-gradient(135deg, #f0fdf4 0%, #ffffff 50%, #f0fdf4 100%);
            --background-secondary: rgba(255, 255, 255, 0.95);
            --background-tertiary: rgba(240, 253, 244, 0.8);
            --text-primary: #1d1d1f;
            --text-secondary: #6b7280;
            --shadow-light: 0 2px 8px rgba(34, 197, 94, 0.1);
            --shadow-medium: 0 4px 16px rgba(34, 197, 94, 0.12);
            --shadow-large: 0 8px 32px rgba(34, 197, 94, 0.15);
            --border-radius: 16px;
            --border-radius-small: 8px;
            --border-radius-large: 20px;
            --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Apple-like easing */
            --transition-fast: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-slow: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 32px;
            background: var(--background-primary);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* ========== Typography ========== */
        h3 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 24px 0;
            color: var(--text-primary);
            letter-spacing: -0.022em;
            line-height: 1.2;
        }

        p {
            margin: 0 0 16px 0;
            color: var(--text-secondary);
            font-size: 17px;
            line-height: 1.5;
        }

        /* ========== Form Elements ========== */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
            letter-spacing: -0.016em;
        }

        input, select {
            width: 100%;
            padding: 16px 20px;
            box-sizing: border-box;
            border: 1px solid #D1D1D6;
            border-radius: var(--border-radius);
            background: var(--background-secondary);
            font-size: 17px;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            outline: none;
            font-family: inherit;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.12);
            transform: translateY(-1px);
        }

        input[type="submit"] {
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            padding: 16px 24px;
            cursor: pointer;
            font-weight: 600;
            font-size: 17px;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            min-height: 50px;
        }

        input[type="submit"]:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        input[type="submit"]:active {
            transform: translateY(0);
        }

        input[type="submit"]:disabled {
            background: var(--secondary-color);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #remember_bssid, #sleep_mode {
            width: auto;
            margin-right: 12px;
            accent-color: var(--primary-color);
        }

        /* ========== AP List Styles ========== */
        #ap_list {
            margin-top: 32px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
            padding-top: 24px;
        }

        #ap_list .scanning {
            font-style: italic;
            color: var(--text-secondary);
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #ap_list a {
            display: block;
            margin-top: 12px;
            color: var(--primary-color);
            text-decoration: none;
            padding: 16px 20px;
            background: var(--background-tertiary);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-large);
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
            animation: itemSlide 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #ap_list a:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(34, 197, 94, 0.1), transparent);
            transition: left 0.6s;
        }

        #ap_list a:hover:before {
            left: 100%;
        }

        #ap_list a:hover {
            background: var(--background-secondary);
            transform: translateY(-6px) scale(1.03) rotate(-1deg);
            box-shadow: var(--shadow-large), 0 0 25px rgba(34, 197, 94, 0.15);
            border-color: var(--primary-color);
        }

        /* ========== Language Switcher ========== */
        .language-switch {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 100;
        }

        .language-switch select {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            border: 2px solid transparent;
            background: var(--background-secondary);
            backdrop-filter: blur(20px);
            font-size: 14px;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            cursor: pointer;
            animation: float 6s ease-in-out infinite;
        }

        .language-switch select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.1), var(--shadow-medium);
            animation: none;
        }

        /* ========== Tab Styles ========== */
        .tabs {
            display: flex;
            margin-top: 32px;
            margin-bottom: 24px;
            padding-left: 32px;
            border-bottom: 1px solid #D1D1D6;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            border-radius: var(--border-radius);
            margin-right: 8px;
            background: transparent;
            transition: var(--transition);
            font-weight: 500;
            font-size: 17px;
            color: var(--text-secondary);
            position: relative;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-light);
        }

        .tab:hover:not(.active) {
            background: var(--background-tertiary);
            color: var(--text-primary);
        }

        .tab-content {
            display: none;
            padding: 32px;
            background: var(--background-secondary);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-light);
            margin: 0 32px 32px 32px;
            animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .tab-content.active {
            display: block;
        }

        /* Main content layout */
        .main-content {
            display: flex;
            gap: 40px;
            margin-top: 24px;
        }

        .left-panel {
            flex: 1;
        }

        .right-panel {
            flex: 1;
            max-width: 400px;
        }

        /* ========== Toast Message Styles ========== */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            color: white;
            padding: 24px 40px;
            border-radius: var(--border-radius-large);
            z-index: 1000;
            opacity: 0;
            transition: var(--transition);
            min-width: 300px;
            text-align: center;
            box-shadow: var(--shadow-large), 0 0 50px rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: toastBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            animation: toastBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* ========== Loading Spinner Styles ========== */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .loading-spinner {
            width: 100px;
            height: 100px;
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--primary-color);
            border-radius: var(--border-radius-large);
            animation: spin 1.2s linear infinite, pulse 2s ease-in-out infinite alternate;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.2);
        }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 32px;
        }

        .loading-text {
            color: white;
            font-size: 20px;
            font-weight: 700;
            animation: pulse 2s infinite;
        }

        /* ========== Animations ========== */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toastBounce {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.05);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ========== Dark Mode Toggle ========== */
        .dark-mode-toggle {
            position: fixed;
            top: 24px;
            left: 24px;
            background: var(--background-secondary);
            backdrop-filter: blur(20px);
            border: 2px solid transparent;
            border-radius: var(--border-radius-large);
            width: 52px;
            height: 52px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: buttonPulse 6s ease-in-out infinite;
        }

        .dark-mode-toggle:hover {
            transform: scale(1.15) rotate(180deg);
            box-shadow: var(--shadow-medium), 0 0 30px rgba(34, 197, 94, 0.2);
            border-color: var(--primary-color);
            animation: none;
        }

        .dark-mode-toggle svg {
            width: 24px;
            height: 24px;
            color: var(--text-primary);
        }

        /* ========== Saved Wi-Fi Section ========== */
        .saved-wifi-section {
            background: var(--background-secondary);
            border-radius: var(--border-radius-large);
            padding: 24px;
            box-shadow: var(--shadow-light);
            margin-bottom: 24px;
            border: 1px solid #D1D1D6;
        }

        .saved-wifi-section h3 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-weight: 700;
            font-size: 20px;
        }

        .saved-wifi-section li {
            padding: 16px 20px;
            margin-bottom: 12px;
            background: var(--background-tertiary);
            border-radius: var(--border-radius);
            transition: var(--transition);
            border: 1px solid #E5E5EA;
        }

        .saved-wifi-section li:hover {
            background: #F2F2F7;
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .saved-wifi-section li:last-child {
            margin-bottom: 0;
        }

        /* ========== Main Content Layout ========== */
        .main-content {
            display: flex;
            gap: 32px;
            margin-top: 24px;
            padding: 0 24px;
        }

        .left-panel {
            flex: 1;
            min-width: 0;
        }

        .right-panel {
            flex: 0 0 400px;
            max-width: 420px;
        }

        /* ========== Dark Mode Styles ========== */
        body.dark-mode {
            --background-primary: #0f172a;
            --background-secondary: #1e293b;
            --background-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --shadow-light: 0 2px 8px rgba(34, 197, 94, 0.2);
            --shadow-medium: 0 4px 16px rgba(34, 197, 94, 0.25);
            --shadow-large: 0 8px 32px rgba(34, 197, 94, 0.3);
        }

        body.dark-mode input, body.dark-mode select {
            background: var(--background-secondary);
            border-color: #38383A;
            color: var(--text-primary);
        }

        body.dark-mode .saved-wifi-section {
            background: var(--background-secondary);
            border-color: #38383A;
        }

        body.dark-mode .saved-wifi-section li {
            background: var(--background-tertiary);
            border-color: #48484A;
        }

        body.dark-mode footer {
            border-top-color: rgba(255, 255, 255, 0.1);
            background: var(--background-secondary);
        }

        body.dark-mode footer a {
            background: var(--background-tertiary);
            border-color: rgba(255, 255, 255, 0.1);
        }

        footer a:hover {
            background: var(--background-secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
            border-color: var(--primary-color);
        }

        body.dark-mode .tab-content {
            background: var(--background-secondary);
        }

        body.dark-mode .dark-mode-toggle svg {
            color: var(--text-primary);
        }

        /* ========== Responsive Design ========== */
        @media (max-width: 1024px) {
            .right-panel {
                flex: 0 0 340px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .main-content {
                flex-direction: column;
                gap: 20px;
                padding: 0 16px;
            }

            .right-panel {
                order: -1;
                flex: none;
                max-width: unset;
            }

            .tabs {
                padding-left: 16px;
            }

            .tab-content {
                margin: 0 16px 16px 16px;
                padding: 20px;
            }

            .language-switch {
                top: 16px;
                right: 16px;
            }

            .dark-mode-toggle {
                top: 16px;
                left: 16px;
            }

            .saved-wifi-section {
                padding: 20px;
            }

            .saved-wifi-section h3 {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 12px;
            }

            .main-content {
                padding: 0 12px;
            }

            .tabs {
                padding-left: 12px;
                margin-top: 20px;
            }

            .tab-content {
                margin: 0 12px 12px 12px;
                padding: 16px;
            }

            .language-switch select {
                font-size: 13px;
                padding: 10px 14px;
            }

            .saved-wifi-section {
                padding: 16px;
            }

            .saved-wifi-section h3 {
                font-size: 16px;
            }

            h3 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast notification -->
    <div class="toast" id="toast"></div>
    
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" data-lang="connecting">Connecting...</div>
        </div>
    </div>
    
    <!-- Language switcher -->
    <div class="language-switch">
        <select id="language" onchange="changeLanguage()">
            <option value="vi-VN">Ti·∫øng Vi·ªát</option>
            <option value="en-US">English</option>
        </select>
    </div>
    
    <!-- Dark mode toggle -->
    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
    </button>
    
    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" onclick="switchTab('new-wifi')" data-lang="new_wifi">New Wi-Fi</div>
        <div class="tab" onclick="switchTab('advanced')" data-lang="advanced_tab">Advanced</div>
    </div>

    <!-- Main Content Layout -->
    <div class="main-content">
        <!-- Left: Tab Contents -->
        <div class="left-panel">
            <!-- New Wi-Fi Tab -->
            <div id="new-wifi-tab" class="tab-content active">
                <div class="new-wifi-section">
                    <h3 data-lang="new_wifi">New Wi-Fi</h3>
                    <p class="error" style="color: red; text-align: center;" id="error"></p>
                    <form action="/submit" method="post" onsubmit="submitForm(event)">
                        <p>
                            <label for="ssid">SSID:</label>
                            <input type="text" id="ssid" name="ssid" required readonly>
                        </p>
                        <p>
                            <label for="password" data-lang="password">Password:</label>
                            <input type="password" id="password" name="password">
                        </p>
                        <p style="text-align: center;">
                            <input type="submit" value="Connect" id="button" data-lang-value="connect">
                        </p>
                    </form>
                    <p id="ap_list"></p>
                </div>
            </div>

            <!-- Advanced Configuration Tab -->
            <div id="advanced-tab" class="tab-content">
                <form action="/advanced/submit" method="post" onsubmit="submitAdvancedForm(event)">
                    <div>
                        <h3 data-lang="advanced_tab">Advanced</h3>
                        <p class="error" style="color: red; text-align: center;" id="advanced_error"></p>
                        
                        <!-- OTA URL -->
                        <p>
                            <label for="ota_url" data-lang="ota_url">Custom OTA URL:</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="text" id="ota_url" name="ota_url" style="flex: 1;">
                                <button type="button" onclick="clearOtaUrl()" style="padding: 8px 12px; border: 1px solid #e1e5e9; border-radius: 8px; background-color: #f8f9fa; color: #666; cursor: pointer; font-size: 12px; transition: all 0.3s ease;">Clear</button>
                            </div>
                        </p>

                        <!-- Google Sheet URL -->
                        <p>
                            <label for="google_sheet_url" data-lang="google_sheet_url">Google Sheet URL:</label>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="text" id="google_sheet_url" name="google_sheet_url" style="flex: 1;">
                                <button type="button" onclick="clearGoogleSheetUrl()" style="padding: 8px 12px; border: 1px solid #e1e5e9; border-radius: 8px; background-color: #f8f9fa; color: #666; cursor: pointer; font-size: 12px; transition: all 0.3s ease;">Clear</button>
                            </div>
                        </p>

                        <!-- Max TX Power -->
                        <p style="display: flex; align-items: center; gap: 10px;">
                            <label for="max_tx_power" data-lang="max_tx_power" style="white-space: nowrap;">Wi-Fi Max TX Power:</label>
                            <select id="max_tx_power" name="max_tx_power">
                                <option value="8">2 dBm</option>
                                <option value="20">5 dBm</option>
                                <option value="28">7 dBm</option>
                                <option value="34">8 dBm</option>
                                <option value="44">11 dBm</option>
                                <option value="52">13 dBm</option>
                                <option value="56">14 dBm</option>
                                <option value="60">15 dBm</option>
                                <option value="66">16 dBm</option>
                                <option value="72">18 dBm</option>
                                <option value="80">20 dBm</option>
                            </select>
                        </p>

                        <!-- Remember BSSID -->
                        <p style="display: flex; align-items: center; gap: 10px;">
                            <label for="remember_bssid" style="margin: 0;">
                                <span data-lang="remember_bssid">Remember BSSID when connecting to Wi-Fi</span>
                            </label>
                            <input type="checkbox" id="remember_bssid" name="remember_bssid">
                        </p>

                        <!-- Sleep Mode -->
                        <p style="display: flex; align-items: center; gap: 10px;">
                            <label for="sleep_mode" style="margin: 0;">
                                <span data-lang="sleep_mode">Enable Sleep Mode</span>
                            </label>
                            <input type="checkbox" id="sleep_mode" name="sleep_mode">
                        </p>

                        <p style="text-align: center;">
                            <input type="submit" value="Save" id="advanced_button" data-lang-value="save">
                        </p>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right: Saved Wi-Fi Panel -->
        <div class="right-panel">
            <div class="saved-wifi-section">
                <h3 data-lang="saved_wifi">Saved Wi-Fi</h3>
                <div id="saved_list_container">
                    <ul id="saved_list">
                        <li><span data-lang="no_saved_wifi">No saved Wi-Fi networks</span></li>
                    </ul>
                </div>

                <!-- Footer -->
                <footer style="margin-top: 32px; padding: 24px 16px; border-top: 2px solid rgba(0, 0, 0, 0.1); text-align: center; font-size: 14px; color: var(--text-primary); background: var(--background-secondary); border-radius: var(--border-radius-large); box-shadow: var(--shadow-light);">
                    <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                        <a href="https://www.facebook.com/kurtt806" target="_blank" style="color: #1877F2; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border-radius: var(--border-radius); background: var(--background-tertiary); transition: var(--transition); font-weight: 600; font-size: 16px; box-shadow: var(--shadow-light); border: 1px solid rgba(0, 0, 0, 0.05);">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                            KH OA
                        </a>
                    </div>
                </footer>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        // ========== Global Variables ==========
        const button = document.getElementById('button');
        const error = document.getElementById('error');
        const ssid = document.getElementById('ssid');
        let support5G = false; // Store 5G support status

        // ========== Translation Data ==========
        const translations = {
            'vi-VN': {
                title: 'C·∫•u h√¨nh m·∫°ng',
                saved_wifi: 'Wi-Fi ƒë√£ l∆∞u',
                new_wifi: 'Wi-Fi m·ªõi',
                password: 'M·∫≠t kh·∫©u:',
                connect: 'K·∫øt n·ªëi',
                connecting: 'ƒêang k·∫øt n·ªëi...',
                select_wifi: 'Ch·ªçn Wi-Fi 2.4G t·ª´ danh s√°ch b√™n d∆∞·ªõi:',
                select_wifi_5g: 'Ch·ªçn Wi-Fi t·ª´ danh s√°ch b√™n d∆∞·ªõi:',
                scanning: 'ƒêang qu√©t...',
                wifi_tab: 'C·∫•u h√¨nh Wi-Fi',
                advanced_tab: 'T√πy ch·ªçn n√¢ng cao',
                ota_url: 'ƒê·ªãa ch·ªâ OTA t√πy ch·ªânh:',
                google_sheet_url: 'ƒê·ªãa ch·ªâ Google Sheet:',
                max_tx_power: 'C√¥ng su·∫•t ph√°t Wi-Fi t·ªëi ƒëa:',
                remember_bssid: 'Ghi nh·ªõ BSSID khi k·∫øt n·ªëi v·ªõi Wi-Fi',
                sleep_mode: 'B·∫≠t ch·∫ø ƒë·ªô ng·ªß',
                save: 'L∆∞u',
                no_saved_wifi: 'Kh√¥ng c√≥ Wi-Fi ƒë√£ l∆∞u'
            },
            'en-US': {
                title: 'Network Configuration',
                saved_wifi: 'Saved Wi-Fi',
                new_wifi: 'New Wi-Fi',
                password: 'Password:',
                connect: 'Connect',
                connecting: 'Connecting...',
                select_wifi: 'Select a 2.4G Wi-Fi from the list below:',
                select_wifi_5g: 'Select a Wi-Fi from the list below:',
                scanning: 'Scanning...',
                wifi_tab: 'Wi-Fi Config',
                advanced_tab: 'Advanced',
                ota_url: 'Custom OTA URL:',
                google_sheet_url: 'Google Sheet URL:',
                max_tx_power: 'Wi-Fi Max TX Power:',
                remember_bssid: 'Remember BSSID when connecting to Wi-Fi',
                sleep_mode: 'Enable Sleep Mode',
                save: 'Save'
            }
        };

        // ========== Language Mapping ==========
        // Maps browser language codes to supported language codes
        const languageMap = {
            // English
            'en': 'en-US', 'en-US': 'en-US', 'en-GB': 'en-US', 'en-CA': 'en-US', 'en-AU': 'en-US',
            // Vietnamese
            'vi': 'vi-VN', 'vi-VN': 'vi-VN'
        };

        // ========== Helper Functions ==========
        
        /**
         * Get supported language code from browser language
         */
        function getSupportedLanguage(lang) {
            // First try exact match
            if (languageMap[lang]) {
                return languageMap[lang];
            }
            // Then try to match only the main language code
            const mainLang = lang.split('-')[0];
            if (languageMap[mainLang]) {
                return languageMap[mainLang];
            }
            // If no match, return English
            return 'en-US';
        }

        /**
         * Toggle dark mode
         */
        function toggleDarkMode() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');
            
            // Save preference to localStorage
            localStorage.setItem('darkMode', isDark);
            
            // Update toggle icon
            const toggleBtn = document.querySelector('.dark-mode-toggle svg');
            if (isDark) {
                toggleBtn.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
            } else {
                toggleBtn.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
            }
        }

        /**
         * Change the page language
         */
        function changeLanguage() {
            const lang = document.getElementById('language').value;
            
            // Check if language is valid
            if (!translations[lang]) {
                console.warn(`Unsupported language: ${lang}, defaulting to English`);
                document.getElementById('language').value = 'en-US';
                return changeLanguage();
            }
            
            // Set page title
            document.title = translations[lang].title;
            
            // Update text content
            document.querySelectorAll('[data-lang]').forEach(element => {
                const key = element.getAttribute('data-lang');
                element.textContent = translations[lang][key];
            });
            
            // Update input values
            document.querySelectorAll('[data-lang-value]').forEach(element => {
                const key = element.getAttribute('data-lang-value');
                element.value = translations[lang][key];
            });
            
            // Update AP list text based on 5G support
            const apList = document.getElementById('ap_list');
            if (apList.firstChild) {
                const selectText = support5G ? translations[lang].select_wifi_5g : translations[lang].select_wifi;
                apList.firstChild.textContent = selectText;
            }
            
            // Save language preference
            localStorage.setItem('preferred_language', lang);
        }

        // ========== Wi-Fi List Management ==========
        
        /**
         * Render saved Wi-Fi list
         */
        function renderSavedList(data) {
            const savedListContainer = document.getElementById('saved_list_container');
            const savedList = document.getElementById('saved_list');
            savedList.innerHTML = '';
            
            data.forEach((ssid, index) => {
                const li = document.createElement('li');
                let html = `<span>${ssid}</span>`;
                
                // Only add priority and delete buttons after the first item
                if (index > 0) {
                    html += ` <span>
                        <button type="button" onclick="setDefaultItem(this, ${index})">‚¨ÜÔ∏è</button>
                        <button type="button" onclick="deleteItem(this, ${index})">‚ùå</button>
                    </span>`;
                } else {
                    html += ` <span><button type="button" onclick="deleteItem(this, ${index})">‚ùå</button></span>`;
                }
                
                li.innerHTML = html;
                savedList.appendChild(li);
            });
            
            // Show/hide container based on whether there are saved networks
            savedListContainer.style.display = data.length > 0 ? 'block' : 'none';
        }

        /**
         * Delete saved Wi-Fi network
         */
        function deleteItem(item, index) {
            item.disabled = true;
            fetch('/saved/delete?index=' + index)
                .then(response => response.json())
                .then(data => {
                    loadSavedList();
                });
        }

        /**
         * Set default Wi-Fi network (move to top)
         */
        function setDefaultItem(item, index) {
            item.disabled = true;
            fetch('/saved/set_default?index=' + index)
                .then(response => response.json())
                .then(data => {
                    loadSavedList();
                });
        }

        /**
         * Load saved Wi-Fi list from server
         */
        function loadSavedList() {
            fetch('/saved/list')
                .then(response => response.json())
                .then(data => {
                    renderSavedList(data);
                });
        }

        /**
         * Load available Wi-Fi networks
         */
        function loadAPList() {
            if (button.disabled) {
                return;
            }

            const lang = document.getElementById('language').value;
            const apList = document.getElementById('ap_list');

            // Check if AP list already has content
            const hasExistingAPs = apList.querySelector('a') !== null;

            // Only show scanning text if there's no existing AP list
            if (!hasExistingAPs) {
                apList.innerHTML = '<p class="scanning">' + translations[lang].scanning + '</p>';
            }

            fetch('/scan')
                .then(response => response.json())
                .then(data => {
                    // Update global 5G support status
                    support5G = data.support_5g;
                    
                    // Use select_wifi_5g if 5G is supported, otherwise use select_wifi
                    const selectText = support5G ? translations[lang].select_wifi_5g : translations[lang].select_wifi;
                    apList.innerHTML = '<p>' + selectText + '</p>';
                    
                    // Iterate through available APs
                    data.aps.forEach(ap => {
                        const link = document.createElement('a');
                        link.href = '#';
                        link.textContent = ap.ssid + ' (' + ap.rssi + ' dBm)';
                        
                        // Add lock icon for secured networks
                        if (ap.authmode === 0) {
                            link.textContent += ' üåê';
                        } else {
                            link.textContent += ' üîí';
                        }
                        
                        link.addEventListener('click', () => {
                            ssid.value = ap.ssid;
                        });
                        
                        apList.appendChild(link);
                    });
                    
                    // Refresh AP list every 5 seconds
                    setTimeout(loadAPList, 5000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    // On error, try again after 5 seconds
                    setTimeout(loadAPList, 5000);
                });
        }

        // ========== Form Submission ==========
        
        /**
         * Submit Wi-Fi connection form
         */
        async function submitForm(event) {
            event.preventDefault();
            button.disabled = true;
            error.textContent = '';

            // Show loading animation
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('show');

            const payload = {
                ssid: ssid.value,
                password: document.getElementById('password').value
            };

            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Connection failed');
                }

                // Connection successful, redirect to done page
                button.disabled = false;
                window.location.href = '/done.html';
            } catch (err) {
                // Hide loading animation on error
                loadingOverlay.classList.remove('show');
                error.textContent = err.message;
                button.disabled = false;
            }
        }

        /**
         * Submit advanced configuration form
         */
        async function submitAdvancedForm(event) {
            event.preventDefault();
            const advancedButton = document.getElementById('advanced_button');
            const advancedError = document.getElementById('advanced_error');
            advancedButton.disabled = true;
            advancedError.textContent = '';

            const config = {
                ota_url: document.getElementById('ota_url').value,
                google_sheet_url: document.getElementById('google_sheet_url').value,
                max_tx_power: parseInt(document.getElementById('max_tx_power').value),
                remember_bssid: document.getElementById('remember_bssid').checked,
                sleep_mode: document.getElementById('sleep_mode').checked
            };

            try {
                const response = await fetch('/advanced/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.error || 'Save failed');
                }

                advancedButton.disabled = false;
                showToast('Configuration saved');
            } catch (err) {
                advancedError.textContent = err.message;
                advancedButton.disabled = false;
            }
        }

        // ========== UI Functions ==========
        
        /**
         * Switch between tabs
         */
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Activate selected tab
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
        }

        /**
         * Show toast notification
         */
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        /**
         * Load advanced configuration from server
         */
        async function loadAdvancedConfig() {
            try {
                const response = await fetch('/advanced/config');
                const data = await response.json();
                
                if (data.ota_url) {
                    document.getElementById('ota_url').value = data.ota_url;
                }
                if (data.google_sheet_url) {
                    document.getElementById('google_sheet_url').value = data.google_sheet_url;
                }
                if (data.max_tx_power) {
                    document.getElementById('max_tx_power').value = data.max_tx_power;
                }
                if (data.remember_bssid !== undefined) {
                    document.getElementById('remember_bssid').checked = data.remember_bssid;
                }
                if (data.sleep_mode !== undefined) {
                    document.getElementById('sleep_mode').checked = data.sleep_mode;
                }
            } catch (error) {
                console.error('Error loading advanced config:', error);
            }
        }

        /**
         * Clear OTA URL input field
         */
        function clearOtaUrl() {
            document.getElementById('ota_url').value = '';
        }

        /**
         * Clear Google Sheet URL input field
         */
        function clearGoogleSheetUrl() {
            document.getElementById('google_sheet_url').value = '';
        }

        // ========== Initialization ==========
        
        /**
         * Initialize page on DOM load
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Get language setting from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            
            // Get browser language
            const browserLang = navigator.language || navigator.userLanguage;
            
            // Priority: URL parameter > local storage > browser language setting
            const savedLang = langParam || 
                             localStorage.getItem('preferred_language') || 
                             getSupportedLanguage(browserLang);
            
            document.getElementById('language').value = savedLang;
            changeLanguage();
            loadSavedList();
            loadAPList();
            loadAdvancedConfig();
        });

        /**
         * Handle browser back button
         */
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                loadSavedList();
            }
        });

        /**
         * Enable SSID input (fix iOS bug)
         */
        ssid.addEventListener('touchstart', () => {
            ssid.removeAttribute('readonly');
            ssid.focus();
        }, {once: true});

        /**
         * Load dark mode preference
         */
        const savedDarkMode = localStorage.getItem('darkMode') === 'true';
        if (savedDarkMode) {
            document.body.classList.add('dark-mode');
            const toggleBtn = document.querySelector('.dark-mode-toggle svg');
            toggleBtn.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />';
        } else {
            // Light mode default - ensure sun icon
            const toggleBtn = document.querySelector('.dark-mode-toggle svg');
            toggleBtn.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />';
        }
    </script>


</body>
</html>
